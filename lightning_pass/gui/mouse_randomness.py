"""Module containing classes used for operations with mouse randomness generation."""
from __future__ import annotations

from typing import Generator

from passgen import passgen
from PyQt5 import QtCore
from PyQt5.QtCore import QEvent, pyqtBoundSignal
from PyQt5.QtWidgets import QLabel

from ..util.exceptions import StopCollectingPositions


class MouseTracker(QtCore.QObject):
    """This class contains functionality for setting up a mouse tracker over a chosen label.

    :param QLabel widget: QLabel widget which will be used for tracking

    """

    position_changed = QtCore.pyqtSignal(QtCore.QPoint)

    def __init__(self, widget: QLabel) -> None:
        """Class contructor."""
        super().__init__(widget)
        self._widget = widget
        self.widget.setMouseTracking(True)
        self.widget.installEventFilter(self)

    @property
    def widget(self) -> QLabel:
        """Widget property.

        :return: Own widget

        """
        return self._widget

    def event_filter(self, event: QEvent, move: QtCore.QEvent.MouseMove) -> object:
        """Event filter.

        :param QLabel event: Label object
        :param MouseMove move: Mouse move event

        :returns: eventFilter of super class

        """
        if move is self.widget and event.type() == QtCore.QEvent.MouseMove:
            self.position_changed.emit(event.pos())
        return super().eventFilter(move, event)

    @staticmethod
    def setup_tracker(label: QLabel, on_change: pyqtBoundSignal) -> None:
        """Set up a mouse tracker over a specified label."""
        tracker = MouseTracker(label)
        tracker.position_changed.connect(on_change)


class Collector:
    """This class contains functionality for recording current mouse position."""

    def __init__(self) -> None:
        """Class contructor."""
        self.randomness_lst: List[int, int] = []

    def __repr__(self) -> str:
        """Provide information about this class."""
        return f"Collector({self.randomness_lst})"

    def __iter__(self) -> Generator:
        """Iterate over the class.

        - yield item from randomness_lst

        """
        yield from self.randomness_lst

    def collect_position(self, pos: QtCore.QPoint) -> bool:
        """Collect mouse position.

        :param QPoint pos: Current cursor position

        :returns: state of the collector list

        :raises StopCollectingPositions: if 1000 mouse positions have been collected

        """
        if len(self.randomness_lst) > 999:
            raise StopCollectingPositions
        self.randomness_lst.append("(%d, %d)" % (pos.x(), pos.y()))
        if len(self.randomness_lst) % 10 == 0:
            return True


class PwdGenerator:
    """Holds user's chosen parameters for password generation and contains the password generation functionality.

    :param List[Tuple[int, int]] randomness_lst: Information about mouse positions
    :param int length: Password length
    :param bool numbers: Password option
    :param bool symbols: Password option
    :param bool lowercase: Password option
    :param bool uppercase: Password option

    """

    def __init__(
        self,
        randomness_lst: list[tuple[int, int]],
        length: int,
        numbers: bool,
        symbols: bool,
        lowercase: bool,
        uppercase: bool,
    ) -> None:
        """Class contructor."""
        self.val_lst = randomness_lst
        self.length = length
        self.numbers = numbers
        self.symbols = symbols
        self.lowercase = lowercase
        self.uppercase = uppercase

    def __repr__(self) -> str:
        """Provide information about this class."""
        return f"""Generator(
               {self.val_lst},
               {self.length},
               {self.numbers},
               {self.symbols},
               {self.lowercase},
               {self.uppercase})
               """

    def generate_password(self, case_type: str = "both") -> str:
        """Generate a password by passgen library.

        Password generation is based on the chosen parameters in the GUI.

        :param str case_type: "both" as a default case

        :returns: password generated by passgen

        """
        if self.lowercase and self.uppercase:
            case_type = "both"
        elif self.lowercase is False:
            case_type = "upper"
        elif self.uppercase is False:
            case_type = "lower"

        return passgen(
            length=self.length,
            punctuation=self.symbols,
            digits=self.numbers,
            case=case_type,
        )
